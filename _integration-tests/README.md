# Integration Tests

The integration tests in this directory run programs instrumented with orchestrion, and compare the traces received by
the Trace Agent to a list of expected traces.

Each test is a directory within the `tests` directory. This directory must contain a go program compilable with
`orchestrion go build`.

## Running Tests Locally

Tests can be run locally with `go test`, using Orchestrion.
First, install the `ddapm-test-agent` if you haven't already:

``` console
$ python3 -m venv venv
$ source ./venv/bin/activate
$ pip install -r ./utils/agent/requirements-dev.txt
```

Then, ensure that Docker is installed and the daemon is running.

Then, compile Orchestrion and use it to run the tests:

```console
$ ../orchestrion go test -tags integration ./...
```

You can run specific tests like so:

```console
$ ../orchestrion go test -tags integration -run=Test/gin ./tests
```

## Creating a New Test

Creating a new test can be done by adding a directory to the `tests` directory. Conventionally, these should be named
the same thing as the integrations they test, when adding a test for a new integration.

A test is a collection of `.go` files which will be instrumented by Orchestrion.
The test should define a `TestCase` type which implements the `testCase` interface,
defined in [./tests/suite.go](./tests/suite.go).
This interface defines the test harness structure and expected APM spans generated by the test.
See the existing tests for examples of how the interface is implemented.

After implementing the test, run `go generate ./tests` to add the test to the suite.
Be sure to run `go get` and `go mod tidy` as needed if the test adds new dependencies,
or if the Orchestrion dependencies have changed.

You can also create multiple test cases in the same package by creating any number of exported types named with
the prefix `TestCase`. Example: `TestCaseClient`, `TestCaseServer`, etc. The corresponding tests will be named
`my_package/Client` and `my_package/Server` in this example.

Use the [testcontainers](https://pkg.go.dev/github.com/testcontainers/testcontainers-go) package to create Docker containers,
if the test requires external services.
