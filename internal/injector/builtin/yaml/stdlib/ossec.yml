# Unless explicitly stated otherwise all files in this repository are licensed
# under the Apache License Version 2.0.
# This product includes software developed at Datadog (https://www.datadoghq.com/).
# Copyright 2023-present Datadog, Inc.
%YAML 1.1
---
meta:
  name: os
  description: Protection from Local File Inclusion (LFI) Attacks
  icon: file

# All calls that are susceptible to LFI attacks go through the os.OpenFile function, therefore we only need to protect
# this function. This can change in the future if new functions are added to the os package that are susceptible to LFI
aspects:
  - id: OpenFile
    join-point:
      all-of:
        - import-path: os
        - function-body:
            function:
              - name: OpenFile
    advice:
      - prepend-statements:
          imports:
            ossec: gopkg.in/DataDog/dd-trace-go.v1/internal/appsec/emitter/ossec
          template: |-
            {{- $path := .Function.Argument 0 -}}
            {{- $flags := .Function.Argument 1 -}}
            if err := ossec.ProtectOpen(nil, {{ $path }}, {{ $flags }}); err != nil {
              return nil, err
            }            
            
