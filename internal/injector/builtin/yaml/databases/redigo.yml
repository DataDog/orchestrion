# Unless explicitly stated otherwise all files in this repository are licensed
# under the Apache License Version 2.0.
# This product includes software developed at Datadog (https://www.datadoghq.com/).
# Copyright 2023-present Datadog, Inc.
---
# yaml-language-server: $schema=../../../../../docs/static/schema.json
meta:
  name: github.com/gomodule/redigo/redis
  description: Redigo is a Go client for the Redis database.
  icon: database

aspects:
  ##############################################################################
  # Dial
  - id: Dial
    join-point:
      function-call: github.com/gomodule/redigo/redis.Dial
    advice:
      - wrap-expression:
          imports:
            redigo: github.com/gomodule/redigo/redis
            redigotrace: gopkg.in/DataDog/dd-trace-go.v1/contrib/gomodule/redigo
          template: |-
            func() (redis.Conn, error) {
              {{ $len := len .AST.Args }}
              {{ if le $len 2 }}
                return redigotrace.Dial({{ index .AST.Args 0 }}, {{ index .AST.Args 1 }})
              {{ else }}
                opts := {{ index .AST.Args 2 }}
                anyOpts := make([]interface{}, 0, len(opts))
                for i, v := range opts {
                  anyOpts[i] = v
                }
                return redigotrace.Dial({{ index .AST.Args 0 }}, {{ index .AST.Args 1 }}, anyOpts...)
              {{ end }}
            }()

  ##############################################################################
  # DialContext
  - id: DialContext
    join-point:
      function-call: github.com/gomodule/redigo/redis.DialContext
    advice:
      - wrap-expression:
          imports:
            redigo: github.com/gomodule/redigo/redis
            redigotrace: gopkg.in/DataDog/dd-trace-go.v1/contrib/gomodule/redigo
          template: |-
            func() (redis.Conn, error) {
              {{ $len := len .AST.Args }}
              {{ if le $len 3 }}
                return redigotrace.DialContext({{ index .AST.Args 0 }}, {{ index .AST.Args 1 }}, {{ index .AST.Args 2 }})
              {{ else }}
                opts := {{ index .AST.Args 3 }}
                anyOpts := make([]interface{}, 0, len(opts))
                for i, v := range opts {
                  anyOpts[i] = v
                }
                return redigotrace.DialContext({{ index .AST.Args 0 }}, {{ index .AST.Args 1 }}, {{ index .AST.Args 2 }}, anyOpts...)
              {{ end }}
            }()

  ##############################################################################
  # DialURL
  - id: DialURL
    join-point:
      function-call: github.com/gomodule/redigo/redis.DialURL
    advice:
      - wrap-expression:
          imports:
            redigo: github.com/gomodule/redigo/redis
            redigotrace: gopkg.in/DataDog/dd-trace-go.v1/contrib/gomodule/redigo
          template: |-
            func() (redis.Conn, error) {
              {{ $len := len .AST.Args }}
              {{ if le $len 1 }}
                return redigotrace.DialURL({{ index .AST.Args 0 }})
              {{ else }}
                opts := {{ index .AST.Args 1 }}
                anyOpts := make([]interface{}, 0, len(opts))
                for i, v := range opts {
                  anyOpts[i] = v
                }
                return redigotrace.DialURL({{ index .AST.Args 0 }}, anyOpts...)
              {{ end }}
            }()
